<!-- test deploy dev -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>InternoClic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Pixelify+Sans:wght@400..700&family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

    <!-- IMPORTANT : afficher les retours à la ligne dans le résultat -->
    <style>
        #resultat { white-space: pre-line; }
    </style>
</head>

<body>
<header>
    <a href="index.html">
        <img src="Images/logo3.png" alt="logo InternoClic"/>
    </a>
    <h1>InternoClic</h1>
</header>

<main class="ordo_liste">
    <h1>Corticothérapie</h1>

    <!-- GENERATEUR -->
    <div class="ordo1">
        <h3 class="titre-ordo">Générateur d'ordonnance de corticothérapie</h3>

        <!-- Variables non copiées -->
        <div class="ordo2 no-copy" style="margin-bottom:12px; display:flex; flex-wrap:wrap; gap:18px; align-items:center;">
            <div>
                <label for="dose_initiale"><strong>Dose initiale (mg/j) :</strong></label>
                <input type="number" id="dose_initiale" min="0" step="0.5" style="margin-left:8px; width:90px;">
            </div>

            <div>
                <label for="duree_semaines"><strong>Durée décroissance (semaines) :</strong></label>
                <input type="number" id="duree_semaines" min="1" step="1" style="margin-left:8px; width:80px;">
            </div>

            <div>
                <label for="premier_palier_duree"><strong>1er palier (semaines) :</strong></label>
                <input type="number" id="premier_palier_duree" min="0" step="1" style="margin-left:8px; width:70px;">
            </div>

            <div>
                <label for="date_debut"><strong>Date de début :</strong></label>
                <input type="date" id="date_debut" style="margin-left:8px;">
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
                <button id="btn-generer" type="button">Générer</button>
            </div>
        </div>

        <!-- Texte copiable -->
        <p class="ordo2" id="resultat"></p>

        <button class="copy-btn">Copier</button>
    </div>

    <!-- INFO PATIENT -->
    <div class="ordo1">
        <h3 class="titre-ordo">Information patient</h3>
        <div class="ordo2">
            <li><a target="_blank" href="https://www.grio.org/documents/page610/questionnaire-alimentation-calcium.pdf">Questionnaire apports calciques</a></li>
            <li><a target="_blank" href="https://drive.google.com/file/d/1y16tjBdct3_ijG_83DurzBcMMKI0l9XZ/view">Triptyque alimentation et corticoïdes</a></li>
            <li><a target="_blank" href="https://www.fai2r.org/wp-content/uploads/2020/01/FAI2R-Corticotherapie_YMP-2020.pdf">Corticothérapie, les médecins répondent à vos questions</a></li>
        </div>
    </div>
</main>

<footer>
    <a href="index.html">Page d'accueil</a>
</footer>

<!-- Copie homogène (boutons .copy-btn) -->
<script src="script.js"></script>

<script>
    function genererOrdonnance() {
        const doseInitiale = parseFloat((document.getElementById("dose_initiale").value || "").replace(",", "."));
        const dureeSemaines = parseInt(document.getElementById("duree_semaines").value, 10);
        const premierPalierDuree = parseInt(document.getElementById("premier_palier_duree").value, 10);
        const dateDebutStr = document.getElementById("date_debut").value;

        if (!doseInitiale || doseInitiale <= 0) {
            alert("Renseigner une dose initiale > 0.");
            return;
        }
        if (!dureeSemaines || dureeSemaines <= 0) {
            alert("Renseigner une durée de décroissance (semaines) > 0.");
            return;
        }
        if (premierPalierDuree < 0 || isNaN(premierPalierDuree)) {
            alert("Renseigner une durée de premier palier valide.");
            return;
        }
        if (!dateDebutStr) {
            alert("Renseigner une date de début.");
            return;
        }
        if (premierPalierDuree >= dureeSemaines) {
            alert("La durée du premier palier doit être inférieure à la durée totale de la décroissance.");
            return;
        }

        // Paliers (incluant 17.5 / 12.5)
        let paliers = [80, 70, 60, 50, 40, 30, 25, 20, 17.5, 15, 12.5, 10, 7.5];
        paliers = paliers.filter(d => d <= doseInitiale);

        if (paliers.length === 0) {
            alert("Aucun palier disponible pour cette dose initiale.");
            return;
        }

        let dateActuelle = new Date(dateDebutStr);

        const semainesRestantes = dureeSemaines - premierPalierDuree;
        const nbPaliersRestants = paliers.length - 1;

        // Si on n'a qu'un palier (dose initiale = plus bas palier), on sort proprement
        let paliersDuree = [];
        if (nbPaliersRestants > 0) {
            const baseDuree = Math.floor(semainesRestantes / nbPaliersRestants);
            const resteSemaines = semainesRestantes % nbPaliersRestants;

            paliersDuree = Array(resteSemaines).fill(baseDuree + 1)
                .concat(Array(nbPaliersRestants - resteSemaines).fill(baseDuree))
                .sort((a, b) => a - b);
        }

        const ordonnance = [];
        ordonnance.push("PREDNISONE cp de 20 et 5 mg :");

        // 1er palier
        let dateFin = new Date(dateActuelle);
        dateFin.setDate(dateActuelle.getDate() + (premierPalierDuree * 7) - 1);
        ordonnance.push(`- ${paliers[0]} mg le matin pendant ${premierPalierDuree} semaine${premierPalierDuree > 1 ? "s" : ""} (du ${dateActuelle.toLocaleDateString("fr-FR")} au ${dateFin.toLocaleDateString("fr-FR")}),`);

        // paliers suivants
        dateActuelle = new Date(dateFin);
        dateActuelle.setDate(dateFin.getDate() + 1);

        for (let i = 1; i < paliers.length; i++) {
            const duree = paliersDuree[i - 1] ?? 0;
            if (duree > 0) {
                const dateDebutPalier = new Date(dateActuelle);
                dateFin = new Date(dateDebutPalier);
                dateFin.setDate(dateDebutPalier.getDate() + (duree * 7) - 1);

                ordonnance.push(`- puis ${paliers[i]} mg le matin pendant ${duree} semaine${duree > 1 ? "s" : ""} (du ${dateDebutPalier.toLocaleDateString("fr-FR")} au ${dateFin.toLocaleDateString("fr-FR")}),`);

                dateActuelle = new Date(dateFin);
                dateActuelle.setDate(dateFin.getDate() + 1);
            }
        }

        ordonnance.push(`- puis 5 mg le matin jusqu'à la prochaine consultation (à partir du ${dateActuelle.toLocaleDateString("fr-FR")}).`);
        ordonnance.push("NE JAMAIS ARRÊTER SANS AVIS MÉDICAL");
        ordonnance.push("");
        ordonnance.push("ZYMAD 50 000 UI : 1 ampoule à boire une fois par mois");

        document.getElementById("resultat").innerText = ordonnance.join("\n");
    }

    // Defaults
    window.addEventListener("DOMContentLoaded", () => {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("dose_initiale").value = 60;
        document.getElementById("duree_semaines").value = 13;
        document.getElementById("premier_palier_duree").value = 3;
        document.getElementById("date_debut").value = today;

        document.getElementById("btn-generer").addEventListener("click", genererOrdonnance);

        // Générer une première fois pour que le bouton "Copier" serve immédiatement
        genererOrdonnance();
    });
</script>
</body>
</html>
