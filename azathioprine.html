<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>InternoClic</title>
        <link href="style.css" rel="stylesheet">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Pixelify+Sans:wght@400..700&family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    </head>

    <body>
        <header>
            <a href="index.html">
                <img src="Images/logo3.png" alt="logo InternoClic"/>  
            </a>
            <h1>InternoClic</h1>
        </header>
        
        <main class="ordo_liste">
            <h1>Azathioprine</h1>
            
            <div class="ordo1">
                <h3 class="titre-ordo">Ordonnance Azathioprine</h3>

                <div class="ordo2" style="margin-bottom: 12px;">
                    <label for="poids-kg"><strong>Poids (kg) :</strong></label>
                    <input id="poids-kg" type="number" min="10" max="250" step="0.1" placeholder="ex : 70"
                        style="margin-left:8px; width:90px;">

                    <br><br>

                    <label for="tpmt-status"><strong>Génotypage TPMT :</strong></label>
                    <select id="tpmt-status" style="margin-left:8px;">
                        <option value="normal" selected>Normal</option>
                        <option value="reduced">Inconnu / intermédiaire</option>
                    </select>
                </div>

                <p class="ordo2" id="ordo-aza">
                    <span id="premiere-ligne">AZATHIOPRINE comprimé :</span><br />
                    <strong><span id="dose-aza">___</span> mg</strong><br />
                    <span id="cp-aza"></span>
                </p>

                <button class="copy-btn">Copier</button>
            </div>

            <div class="ordo1">
                <h3 class="titre-ordo">Bilan pré-thérapeutique</h3>
                <p class="ordo2">
                    Faire réaliser par un laboratoire d'analyses médicales, à jeun, à domicile si besoin :<br>
                    <br>
                    - Génotypage TPMT
                    - NFP<br>
                    - Ionogramme sanguin, créatinine<br>
                    - ASAT ALAT GGT PAL Bilirubine totale<br>
                    - CRP<br>
                    - Sérologies VIH, VHB, VHC<br>
                </p>
                <button class="copy-btn">Copier</button>
            </div>

            <div class="ordo1">
                <h3 class="titre-ordo">Surveillance biologique</h3>
                <p class="ordo2">
                    Faire réaliser dans un laboratoire, à jeun, à domicile si besoin :<br><br>
                    1 fois par semaine pendant 4 semaines, puis 1 fois toutes les 2 semaines pendant 4 semaines,
                    puis 1 fois par mois pendant 3 mois, puis tous les 3 mois :<br>
                    - NFP<br>
                    - ASAT ALAT<br><br>
                    En plus avant la prochaine consultation (selon le contexte) :<br>
                    - Ionogramme sanguin, créatinine<br>
                    - CRP<br>
                    - GGT PAL Bilirubine totale
                </p>
                <button class="copy-btn">Copier</button>
            </div>

            <div class="ordo1">
                <h3 class="titre-ordo">Information patient</h3>
                <div class="ordo2">
                    <li>
                        <a target="_blank" href="https://www.getaid.org/wp-content/uploads/2025/07/GETAID_AZATHIOPRINE_V4_20200610_version-t%C3%A9l%C3%A9chargeable_20250626.pdf">
                            Fiche patient Azathioprine (GETAID)
                        </a>
                    </li>
                </div>
            </div>
        </main>
       
        <footer>
            <a href="index.html">Page d'accueil</a>
        </footer>
    
        <script src="script.js"></script>

        <script>
            // Règles inchangées (base) : 2 mg/kg/j, arrondi au multiple de 25 mg supérieur, max 200 mg/j
            // Modif : si TPMT inconnue/intermédiaire -> dose /2, arrondi au 25 mg supérieur, max 100 mg/j

            function ceilToNext25(x) {
                return Math.ceil(x / 25) * 25;
            }

            function chooseTabletStrength(doseMg) {
                // Format demandé : "X comprimés de YY mg" (une seule force)
                // Choix : si divisible par 50 -> cp 50 mg ; sinon -> cp 25 mg
                return doseMg % 50 === 0 ? 50 : 25;
            }

            function formatComprimésUneForce(doseMg) {
                const strength = chooseTabletStrength(doseMg);
                const n = doseMg / strength;

                if (!Number.isFinite(n) || n <= 0 || Math.floor(n) !== n) return "";

                const unit = n === 1 ? "comprimé" : "comprimés";
                return `${n} ${unit} de ${strength} mg`;
            }

            function computeDoseAzathioprine(poidsKg, tpmtStatus) {
                // Dose standard
                const doseTheorique = poidsKg * 2;            // 2 mg/kg/j
                let dose = ceilToNext25(doseTheorique);
                dose = Math.min(dose, 200);

                // TPMT inconnue/intermédiaire -> 1/2 dose, max 100 mg/j, arrondi au 25 mg supérieur
                if (tpmtStatus === "reduced") {
                    dose = ceilToNext25(dose / 2);
                    dose = Math.min(dose, 100);
                }

                return dose;
            }

            function updateAzathioprineDose() {
                const poidsEl = document.getElementById("poids-kg");
                const tpmtEl = document.getElementById("tpmt-status"); // valeurs attendues: "normal" ou "reduced"
                const doseSpan = document.getElementById("dose-aza");
                const cpSpan = document.getElementById("cp-aza");

                const poids = parseFloat(poidsEl?.value);
                const tpmtStatus = tpmtEl?.value || "normal";

                if (!poids || poids <= 0) {
                    if (doseSpan) doseSpan.textContent = "___";
                    if (cpSpan) cpSpan.textContent = "";
                    return;
                }

                const dose = computeDoseAzathioprine(poids, tpmtStatus);
                const comp = formatComprimésUneForce(dose);

                if (doseSpan) doseSpan.textContent = dose.toString();

                // Texte demandé : "**mg le matin soit * comprimés de **mg"
                if (cpSpan) cpSpan.textContent = `- ${dose} mg le matin soit ${comp}`;
            }

            document.getElementById("poids-kg")?.addEventListener("input", updateAzathioprineDose);
            document.getElementById("tpmt-status")?.addEventListener("change", updateAzathioprineDose);

            updateAzathioprineDose();
        </script>
    </body>
</html>
